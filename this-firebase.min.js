// ThisFirebase version 1.0.0 (http://thisjs.com/#plugins&firebase) | License (http://thisjs.com/#license) | (c) 2016 Ezra Obiwale

ThisApp.extend({FB:function(){return this.tryCatch(function(){return{updatedEvents:{added:{},changed:{},removed:{}},eventCallbacks:{added:{},changed:{},removed:{}},isConnected:function(callback){return this.read('.info/connected',callback);},onConnected:function(callback){this.ref('.info/connected').on('value',function(snap){if(snap.val())
_this.__.callable(callback).call(_this);});return this;},onDisconnected:function(callback){this.ref('.info/connected').on('value',function(snap){if(!snap.val())
_this.__.callable(callback).call(_this);});return this;},onAdded:function(location,successCallback){var _this=this;this.eventCallbacks.added[location]=successCallback;this.ref(location).on('child_added',function(resp){if(!_this.updatedEvents.added[location])
_this.call(successCallback,resp);delete _this.updatedEvents.added[location];});return this;},ignoreAdded:function(location){return this.off(location,'child_added');},onChanged:function(location,successCallback){var _this=this;this.eventCallbacks.changed[location]=successCallback;this.ref(location).on('child_changed',function(resp){if(!_this.updatedEvents.changed[location])
_this.call(successCallback,resp);delete _this.updatedEvents.changed[location];});return this;},ignoreChanged:function(location){return this.off(location,'child_changed');},onRemoved:function(location,successCallback){var _this=this;this.eventCallbacks.removed[location]=successCallback;this.ref(location).on('child_removed',function(resp){if(!_this.updatedEvents.removed[location])
_this.call(successCallback,resp);delete _this.updatedEvents.removed[location];});return this;},ignoreRemoved:function(location){return this.off(location,'child_removed');},watch:function(location,addedCallback,changedCallback,removedCallback){if(addedCallback)
this.onAdded(location,addedCallback);if(changedCallback)
this.onChanged(location,changedCallback);if(removedCallback)
this.onRemoved(location,removedCallback);return this;},unwatch:function(location){this.ref(location).off();return this;},off:function(location,event){if(event){var _event=event.split('_')[1];if(_event&&this.eventCallbacks[_event])
delete this.eventCallbacks[_event][location];this.ref(location).off(event);}
return this;},create:function(location,data,successCallback,errorCallback){if(!location||!data)
return false;var ref=this.ref(location).push(),uid=ref.key;if(_this.fbConfig.uid&&!data[_this.fbConfig.uid])
data[_this.fbConfig.uid]=uid;ref=ref.set(data);if(_this.fbConnected)
ref.then(successCallback).catch(errorCallback);else{this.updatedEvents.added[location]=true;_this.__.callable(this.eventCallbacks.added[location]).call(this,data,uid);_this.__.callable(successCallback).call(_this,data,uid,_this.fbConnected);ref.catch(function(){_this.__.callable(this.eventCallbacks.removed[location]).call(this,data,uid);_this.__.callable(errorCallback).call(_this,_this.fbConnected);});}
return ref;},read:function(location,successCallback,errorCallback){if(!location)
return false;var _this=this;return this.ref(location).once('value').then(function(resp){_this.call(successCallback,resp);}).catch(errorCallback);},update:function(location,data,successCallback,errorCallback){if(!location||!data)
return false;var ref=this.ref(location).update(data),fb=this;if(_this.fbConnected)
ref.then(successCallback).catch(errorCallback);else{this.updatedEvents.added[location]=true;_this.__.callable(this.eventCallbacks.added[location]).call(this,data,data[_this.fbConfig.uid]);_this.__.callable(successCallback).call(_this,data,data[_this.fbConfig.uid],_this.fbConnected);ref.catch(function(){fb.read(location,function(data,id){_this.__.callable(this.eventCallbacks.updated[location]).call(this,data,id);_this.__.callable(errorCallback).call(_this,_this.fbConnected);});});}
return ref;},delete:function(location,successCallback,errorCallback){if(!location)
return false;var ref=this.ref(location).remove(),fb=this;if(_this.fbConnected)
ref.then(successCallback).catch(errorCallback);else{this.updatedEvents.added[location]=true;_this.__.callable(this.eventCallbacks.added[location]).call(this);_this.__.callable(successCallback).call(_this);ref.catch(function(){fb.read(location,function(data,id){_this.__.callable(this.eventCallbacks.added[location]).call(this,data,id);_this.__.callable(successCallback).call(_this,data,id,_this.fbConnected);});});}
return ref;},ref:function(location){return firebase.database().ref(location);},call:function(callback,snapshot){try{_this.__.callable(callback).call(this,snapshot.val(),snapshot.key);}
catch(e){console.error(e.message);}
return this;}};});},firebase:function(fbConfig){this.tryCatch(function(){if(this.running)
throw'Method firebase() must be called before method start()';var _this=this;this.fbWatching={};this.fbCallbacks={success:{create:{},update:{},delete:{}},error:{create:{},update:{},delete:{}}};this.fbConfig=this.__.extend({auth:false,uid:'id',connectionChanged:function(status){if(!status)
_this.error('Connection lost!');}},fbConfig);firebase.initializeApp(fbConfig);this.FB().ref('.info/connected').on('value',function(snap){_this.fbConnected=snap.val();_this.__.callable(_this.fbConfig.connectionChanged).call(_this,snap.val());});this.watch(function(location,callback){if(!location.endsWith('/'))
location+='/';_this.FB().watch(location,function(data,id){if(_this.fbConfig.uid)
data[_this.fbConfig.uid]=id;_this.__.callable(callback).call(null,data,_this.fbConfig.uid,'created',_this.fbConnected);},function(data,id){if(_this.fbConfig.uid)
data[_this.fbConfig.uid]=id;_this.__.callable(callback).call(null,data,_this.fbConfig.uid,'updated',_this.fbConnected);},function(data,id){if(_this.fbConfig.uid)
data[_this.fbConfig.uid]=id;_this.__.callable(callback).call(null,data,_this.fbConfig.uid,'deleted',_this.fbConnected);});_this.fbWatching[location]=true;});this.setDataTransport(function(config){if(config.action==='create'){_this.fbCallbacks.success[config.action][config.url]=config.success;_this.fbCallbacks.error[config.action][config.url]=config.error;}
if(config.action==='update'||config.action==='delete'){var parts=config.url.split('/');_this.__.arrayRemove(parts,parts.length-1);_this.fbCallbacks.success[config.action][parts.join("/")+'/']=config.success;_this.fbCallbacks.error[config.action][parts.join("/")+'/']=config.error;}
switch(config.action){case'create':return _this.FB().create(config.url,config.data,config.success,config.error);case'read':_this.FB().read(config.url,function(data,id){if(_this.fbConfig.uid&&!config.collection)
data[_this.fbConfig.uid]=id;this.__.callable(config.success).call(this,data,_this.fbConfig.uid);}.bind(this),config.error);break;case'update':_this.FB().update(config.url,config.data,config.success,config.error);break;case'delete':_this.FB().delete(config.url,config.success,config.error);break;case'search':break;}
return true;});return this.cacheData(false).setDataKey(null);});return this;}});